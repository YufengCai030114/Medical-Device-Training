<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Medical Training – Login</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
        body{
            font-family:ui-sans-serif,system-ui,Arial;
            background:#f3f4f6;
            margin:0;
            min-height:100vh;
            display:flex;
            align-items:center;
            justify-content:center;
        }
        .card{
            background:#fff;
            border:1px solid #e5e7eb;
            border-radius:16px;
            box-shadow:0 10px 25px rgba(15,23,42,0.06);
            padding:24px 24px 20px;
            width:360px;
            box-sizing:border-box;
        }
        h1{
            margin:0 0 4px;
            font-size:22px;
        }
        .muted{color:#6b7280;font-size:13px;margin-bottom:16px;}
        label{
            display:block;
            font-size:13px;
            margin-bottom:4px;
            color:#374151;
        }
        input,button{
            width:100%;
            box-sizing:border-box;
            padding:8px 10px;
            border-radius:8px;
            border:1px solid #e5e7eb;
            font-size:14px;
            margin-bottom:12px;
        }
        button{
            background:#2563eb;
            color:#fff;
            font-weight:500;
            cursor:pointer;
            border:none;
        }
        button:hover{filter:brightness(1.05);}
        .top-link{
            font-size:12px;
            color:#6b7280;
            margin-bottom:12px;
            display:flex;
            justify-content:space-between;
            align-items:center;
        }
        .top-link a{
            color:#2563eb;
            text-decoration:none;
            font-weight:500;
        }
        .error{
            font-size:13px;
            color:#b91c1c;
            background:#fef2f2;
            border:1px solid #fecaca;
            border-radius:8px;
            padding:6px 10px;
            margin-bottom:10px;
        }
        .hidden{display:none;}
        .footer-text{
            font-size:12px;
            color:#9ca3af;
            margin-top:8px;
            text-align:center;
        }
    </style>
</head>
<body>
<div class="card">
    <div class="top-link">
        <span>Medical Training</span>
        <a href="index.html">← Back to home</a>
    </div>

    <h1>Login</h1>
    <div class="muted">Sign in with your Medical Training account.</div>

    <div id="errorBox" class="error hidden"></div>

    <form id="loginForm">
        <label for="username">Username</label>
        <input id="username" name="username"  autocomplete="username" />

        <label for="password">Password</label>
        <input id="password" name="password" type="password" autocomplete="current-password" />

        <button type="submit">Login</button>
    </form>

    <div class="footer-text">
        Don’t have an account?
        <a href="register.html" style="color:#2563eb;text-decoration:none;">
            Register here
        </a>
    </div>
</div>

<script>
    // PostgREST base URL (same pattern as main UI)
    const API_BASE = (path) => `http://localhost:3000/${path}`;

    const errorBox = document.getElementById('errorBox');

    function showError(msg){
        errorBox.textContent = msg;
        errorBox.classList.remove('hidden');
    }

    function hideError(){
        errorBox.classList.add('hidden');
    }

    async function doLogin(username, password) {
        hideError();
        try {
            const params = new URLSearchParams();
            params.append('select', 'id,username');
            params.append('username', `eq.${username}`);
            params.append('password', `eq.${password}`);

            const res = await fetch(API_BASE('user?' + params.toString()), {
                headers: {
                    'Accept': 'application/json'
                }
            });

            if (!res.ok) {
                throw new Error('HTTP ' + res.status);
            }

            const data = await res.json();

            if (!Array.isArray(data) || data.length === 0) {
                showError('Invalid username or password.');
                return;
            }

            const row = data[0];

            // Simple role inference: usernames starting with "trainer" are trainers, others trainees
            const role = username.startsWith('trainer') ? 'trainer' : 'trainee';

            // Store user info for the main UI (read by getCurrentUser in main page)
            localStorage.setItem('mt_user', JSON.stringify({
                id: row.id,
                username: row.username,
                role
            }));

            // Redirect back to main UI
            window.location.href = 'simple-interface-prototype-fetch.html';
        } catch (err) {
            console.error(err);
            showError('Login error: ' + err.message);
        }
    }

    document.getElementById('loginForm').addEventListener('submit', (e) => {
        e.preventDefault();

        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;

        if (!username || !password) {
            showError('Please enter username and password.');
            return;
        }

        doLogin(username, password);
    });
</script>
</body>
</html>
